# Avalon A1126pro Firmware

## 📋 Описание проекта

Полностью восстановленная прошивка для ASIC-майнера **Avalon A1126pro** на базе процессора **Kendryte K210**.

Проект создан путём глубокого реверс-инжиниринга оригинального дампа прошивки (`donor_dump.bin`) с использованием Ghidra и ручного анализа декомпилированного кода.

---

## 🔧 Технические характеристики

### Процессор
| Параметр | Значение |
|----------|----------|
| Модель | Kendryte K210 |
| Архитектура | RISC-V 64-bit (rv64imafc) |
| Частота | 400 MHz |
| Ядра | 2 (Dual-core) |
| RAM | 8 MB SRAM |
| Flash | W25Q64 (8 MB SPI Flash) |

### ASIC чипы
| Параметр | Значение |
|----------|----------|
| Модель | Avalon10 A1126 |
| Модулей | До 4 |
| Чипов на модуль | 114 |
| Ядер на чип | 72 |
| Всего ядер | 114 × 72 × 4 = 32,832 |

### Сеть и управление
| Параметр | Значение |
|----------|----------|
| Протокол майнинга | Stratum (TCP) |
| API порт | 4028 (CGMiner API) |
| HTTP порт | 80 (Web-интерфейс) |
| Сетевой чип | DM9051 (SPI Ethernet) |

---

## 📁 Структура проекта

\`\`\`
Avalon1126pro/
├── avalon1126.bin              # Скомпилированная прошивка (504 KB)
├── avalon1126.elf              # ELF с отладочной информацией
├── donor_dump.bin              # Оригинальный дамп flash (8 MB)
├── decompiled/                 # Декомпилированный код (справка)
│   ├── firmware.c              # Основной декомпилированный код
│   ├── all_functions.c         # Все функции
│   └── function_list.txt       # Список функций
├── kendryte-freertos-sdk/      # SDK с исходниками
│   └── src/avalon1126/         # ← ИСХОДНЫЙ КОД ПРОЕКТА
│       ├── main.c              # Точка входа, инициализация
│       ├── cgminer.h           # Общие определения CGMiner
│       ├── avalon10.c/h        # Драйвер ASIC Avalon10
│       ├── pool.c/h            # Управление пулами
│       ├── stratum.c/h         # Stratum протокол
│       ├── network.c/h         # Сетевой стек
│       ├── work.c/h            # Управление работой (jobs)
│       ├── api.c/h             # CGMiner API сервер
│       ├── config.c/h          # Конфигурация (flash)
│       └── w25qxx.c/h          # Драйвер W25Q64 flash
├── README.md                   # Эта документация
└── .gitignore
\`\`\`

---

## 🔨 Сборка проекта

### Требования

1. **Kendryte Toolchain** - GCC 8.2.0 для RISC-V
   - Скачать: https://kendryte.com/downloads/
   - Или: https://github.com/kendryte/kendryte-gnu-toolchain/releases

2. **CMake** версии 3.5 или выше

3. **Make** (GNU Make)

### Шаги сборки

\`\`\`bash
# 1. Клонируйте репозиторий
git clone https://github.com/quaxistech/Avalon1126pro.git
cd Avalon1126pro

# 2. Скачайте и распакуйте Kendryte toolchain
wget https://github.com/kendryte/kendryte-gnu-toolchain/releases/download/v8.2.0-20190409/kendryte-toolchain-ubuntu-amd64-8.2.0-20190409.tar.xz
tar -xf kendryte-toolchain-ubuntu-amd64-8.2.0-20190409.tar.xz
mv kendryte-toolchain-ubuntu-amd64-8.2.0-20190409 kendryte-toolchain

# 3. Соберите проект
cd kendryte-freertos-sdk
mkdir build && cd build
cmake .. -DPROJ=avalon1126 -DTOOLCHAIN=../../kendryte-toolchain/bin
make -j\$(nproc)

# 4. Готовая прошивка
ls -la avalon1126.bin
\`\`\`

### Результат сборки

| Файл | Размер | Описание |
|------|--------|----------|
| \`avalon1126.bin\` | ~500 KB | Прошивка для записи в flash |
| \`avalon1126\` | ~6.5 MB | ELF файл с отладочной информацией |

---

## 📥 Прошивка устройства

### Использование kflash

\`\`\`bash
# Установка kflash
pip install kflash

# Прошивка через UART
kflash -p /dev/ttyUSB0 -b 1500000 avalon1126.bin

# С указанием адреса
kflash -p /dev/ttyUSB0 -b 1500000 -a 0x0 avalon1126.bin
\`\`\`

### ISP режим K210

1. Подключите USB-UART к пинам TX/RX K210
2. Удерживайте кнопку BOOT при включении
3. Запустите kflash

---

## 🌐 API интерфейс

### Подключение

- **Порт**: 4028 (TCP)
- **Формат**: JSON
- **Совместимость**: CGMiner API 3.2

### Команды

| Команда | Описание |
|---------|----------|
| \`version\` | Версия CGMiner и API |
| \`summary\` | Общая статистика майнера |
| \`pools\` | Информация о пулах |
| \`devs\` | Информация об устройствах (ASIC) |
| \`config\` | Текущая конфигурация |
| \`stats\` | Детальная статистика |
| \`coin\` | Информация о монете |
| \`asc\` | Статус конкретного ASC |
| \`asccount\` | Количество ASC устройств |

### Примеры использования

\`\`\`bash
# Получить версию
echo '{"command":"version"}' | nc -w 1 192.168.1.100 4028

# Получить статистику
echo '{"command":"summary"}' | nc -w 1 192.168.1.100 4028

# Информация о пулах
echo '{"command":"pools"}' | nc -w 1 192.168.1.100 4028

# Добавить пул
echo '{"command":"addpool","parameter":"stratum+tcp://pool.example.com:3333,worker,password"}' | nc -w 1 192.168.1.100 4028
\`\`\`

### Формат ответа

\`\`\`json
{
  "STATUS": [{"STATUS":"S","When":1234567890,"Code":11,"Msg":"Summary","Description":"cgminer 4.11.1"}],
  "SUMMARY": [{
    "Elapsed": 3600,
    "MHS av": 50000.00,
    "MHS 5s": 51234.56,
    "Found Blocks": 0,
    "Accepted": 1234,
    "Rejected": 5,
    "Hardware Errors": 2
  }],
  "id": 1
}
\`\`\`

---

## ⚙️ Конфигурация

### Параметры ASIC (Avalon10)

| Параметр | По умолчанию | Диапазон | Описание |
|----------|--------------|----------|----------|
| Частота | 400 MHz | 400-500 MHz | Частота чипов |
| Напряжение | 780 mV | 700-900 mV | Напряжение ядра |
| Вентилятор мин | 10% | 0-100% | Минимальные обороты |
| Вентилятор макс | 100% | 0-100% | Максимальные обороты |
| Целевая температура | 75°C | 50-85°C | Целевая температура |
| Перегрев | 95°C | 80-105°C | Аварийное отключение |

### Сетевые настройки

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| DHCP | Включён | Автоматическое получение IP |
| IP адрес | 192.168.1.254 | Статический IP (если DHCP выключен) |
| Маска | 255.255.255.0 | Маска подсети |
| Шлюз | 192.168.1.1 | Шлюз по умолчанию |
| DNS | 8.8.8.8 | DNS сервер |

### Настройки пулов

Поддерживается до 3 пулов с приоритетом:

\`\`\`
Pool 1: stratum+tcp://pool1.example.com:3333 (приоритет 0)
Pool 2: stratum+tcp://pool2.example.com:3333 (приоритет 1)
Pool 3: stratum+tcp://pool3.example.com:3333 (приоритет 2)
\`\`\`

---

## 🏗️ Архитектура прошивки

### Задачи FreeRTOS

| Задача | Приоритет | Стек | Описание |
|--------|-----------|------|----------|
| \`stratum_send\` | 5 | 4KB | Отправка данных на пул |
| \`stratum_recv\` | 5 | 4KB | Приём данных от пула |
| \`watchdog\` | 6 | 2KB | Сторожевой таймер |
| \`monitor\` | 4 | 4KB | Мониторинг температуры |
| \`api_server\` | 3 | 8KB | CGMiner API сервер |
| \`http_server\` | 3 | 8KB | Web-интерфейс |
| \`led_control\` | 2 | 1KB | Управление индикаторами |

### Модули

\`\`\`
┌─────────────────────────────────────────────────────────────┐
│                      Приложение                              │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│   Stratum   │    Pool     │    API      │      HTTP        │
│  Protocol   │  Manager    │   Server    │     Server       │
├─────────────┴─────────────┴─────────────┴──────────────────┤
│                     Work Manager                             │
├─────────────────────────────────────────────────────────────┤
│                   Avalon10 Driver                            │
├─────────────────────────────────────────────────────────────┤
│           SPI          │          I2C          │    GPIO    │
├────────────────────────┴───────────────────────┴────────────┤
│                      FreeRTOS                                │
├─────────────────────────────────────────────────────────────┤
│                    Kendryte K210 HAL                         │
└─────────────────────────────────────────────────────────────┘
\`\`\`

---

## 📊 Сравнение с оригиналом

| Параметр | Оригинал (donor_dump.bin) | Наша сборка |
|----------|---------------------------|-------------|
| Размер файла | 8,388,608 байт | 504,924 байт |
| Активный код | ~47,616 байт | 504,924 байт |
| Формат | K210 flash dump | Kendryte SDK binary |
| RTOS | Минимальный | Полный FreeRTOS |
| Сетевой стек | Минимальный | Полный lwIP |
| Отладка | Нет | Есть (ELF) |

---

## 🔍 Реверс-инжиниринг

### Инструменты

- **Ghidra** - дизассемблирование и декомпиляция
- **binwalk** - анализ структуры прошивки
- **strings** - извлечение строк

### Ключевые находки

1. **Строки CGMiner**: \`cgminer 4.11.1\`, \`API 3.2\`
2. **Модель**: \`AvalonMiner 1126\`, \`AV10MM\`
3. **Конфигурация**: \`network.cfg\`, \`product.cfg\`
4. **Функции**: 1,847 функций декомпилировано

### Карта памяти K210

| Регион | Адрес | Размер | Описание |
|--------|-------|--------|----------|
| ROM | 0x00000000 | 128KB | Boot ROM |
| SRAM | 0x80000000 | 8MB | Основная память |
| Flash | 0x00000000 | 8MB | SPI Flash (W25Q64) |
| AI SRAM | 0x80600000 | 2MB | KPU память |
| Peripheral | 0x50000000 | - | Регистры периферии |

---

## 📝 Лицензия

Проект основан на **CGMiner 4.11.1** и распространяется под лицензией **GPLv3**.

---

## 👥 Авторы

Восстановлено путём реверс-инжиниринга из оригинальной прошивки.

**Репозиторий**: https://github.com/quaxistech/Avalon1126pro

---

## ⚠️ Отказ от ответственности

Данный проект предоставляется "как есть" без каких-либо гарантий. Используйте на свой страх и риск. Авторы не несут ответственности за любой ущерб, причинённый использованием данного программного обеспечения.
