# Avalon A1126pro Firmware

## 📋 Описание проекта

Полностью восстановленная прошивка для ASIC-майнера **Avalon A1126pro** на базе процессора **Kendryte K210**.

Проект создан путём глубокого реверс-инжиниринга оригинального дампа прошивки (`donor_dump.bin`) с использованием Ghidra и ручного анализа декомпилированного кода.

### ✅ Реализованный функционал

- ✅ **Mock Layer** — тестирование без реального оборудования
- ✅ **SPI Flash драйвер** (W25Q64) — чтение/запись/стирание
- ✅ **Сетевой стек** — lwIP + DM9051 SPI Ethernet
- ✅ **Stratum протокол** — полный парсинг mining.notify, submit
- ✅ **Work Manager** — формирование заголовка блока, Merkle Root, SHA256d
- ✅ **ASIC драйвер** — SPI связь с Avalon10, PWM вентиляторы
- ✅ **CGMiner API** — TCP сервер на порту 4028
- ✅ **Термозащита** — мониторинг температуры, авто-регулировка

---

## 🔧 Технические характеристики

### Процессор
| Параметр | Значение |
|----------|----------|
| Модель | Kendryte K210 |
| Архитектура | RISC-V 64-bit (rv64imafc) |
| Частота | 400 MHz |
| Ядра | 2 (Dual-core) |
| RAM | 8 MB SRAM |
| Flash | W25Q64 (8 MB SPI Flash) |

### ASIC чипы
| Параметр | Значение |
|----------|----------|
| Модель | Avalon10 A1126 |
| Модулей | До 4 |
| Чипов на модуль | 114 |
| Ядер на чип | 72 |
| Всего ядер | 114 × 72 × 4 = 32,832 |
| Хэшрейт | ~50 TH/s на модуль |

### Сеть и управление
| Параметр | Значение |
|----------|----------|
| Протокол майнинга | Stratum (TCP) |
| API порт | 4028 (CGMiner API) |
| HTTP порт | 80 (Web-интерфейс) |
| Сетевой чип | DM9051 (SPI Ethernet) |

---

## 📁 Структура проекта

```
Avalon1126pro/
├── README.md                       # Эта документация
├── donor_dump.bin                  # Оригинальный дамп flash (8 MB)
│
├── decompiled/                     # Декомпилированный код (справка)
│   ├── firmware.c                  # Основной декомпилированный код
│   ├── all_functions.c             # Все 1847 функций
│   ├── function_list.txt           # Список функций с адресами
│   └── memory_map.txt              # Карта памяти
│
├── kendryte-freertos-sdk/          # SDK с исходниками
│   ├── build/                      # Папка сборки
│   │   ├── avalon1126              # ELF файл (5 MB)
│   │   └── avalon1126.bin          # Прошивка (362 KB)
│   │
│   └── src/avalon1126/             # ← ИСХОДНЫЙ КОД ПРОЕКТА
│       ├── main.c                  # Точка входа, FreeRTOS задачи
│       ├── cgminer.h               # Общие определения CGMiner
│       ├── avalon10.c/h            # Драйвер ASIC Avalon10
│       ├── pool.c/h                # Управление пулами
│       ├── stratum.c/h             # Stratum протокол (JSON-RPC)
│       ├── network.c/h             # Сетевой стек (lwIP + DM9051)
│       ├── work.c/h                # Формирование заголовка блока
│       ├── api.c/h                 # CGMiner API сервер
│       ├── config.c/h              # Конфигурация (flash)
│       ├── w25qxx.c/h              # Драйвер W25Q64 SPI flash
│       ├── mock_hardware.c/h       # Эмуляция оборудования
│       ├── CMakeLists.txt          # CMake конфигурация
│       └── project.cmake           # Настройки проекта
│
└── kendryte-toolchain/             # RISC-V тулчейн GCC 8.2.0
```

---

## 🔨 Сборка проекта

### Требования

1. **Kendryte Toolchain** — GCC 8.2.0 для RISC-V
   - Скачать: https://github.com/kendryte/kendryte-gnu-toolchain/releases

2. **CMake** версии 3.5 или выше

3. **Make** (GNU Make)

### Обычная сборка (для реального железа)

```bash
# 1. Перейдите в папку SDK
cd kendryte-freertos-sdk

# 2. Создайте папку сборки
mkdir -p build && cd build

# 3. Конфигурируйте проект
cmake .. -DPROJ=avalon1126

# 4. Соберите
make -j$(nproc)

# 5. Готовая прошивка
ls -la avalon1126.bin
```

### Сборка с эмуляцией (для тестирования без железа)

```bash
cmake .. -DPROJ=avalon1126 -DUSE_MOCK_HARDWARE=ON
make -j$(nproc)
```

При включении `USE_MOCK_HARDWARE` активируются:
- `MOCK_SPI_FLASH=1` — эмуляция 8 MB flash памяти
- `MOCK_NETWORK=1` — эмуляция сокетов и Stratum ответов
- `MOCK_ASIC=1` — эмуляция 4 ASIC модулей с температурой

### Результат сборки

| Файл | Размер | Описание |
|------|--------|----------|
| `avalon1126.bin` | ~362 KB | Прошивка для записи в flash |
| `avalon1126` | ~5 MB | ELF файл с отладочной информацией |

---

## 📥 Прошивка устройства

### Использование kflash

```bash
# Установка kflash
pip install kflash

# Прошивка через UART
kflash -p /dev/ttyUSB0 -b 1500000 avalon1126.bin

# С указанием адреса
kflash -p /dev/ttyUSB0 -b 1500000 -a 0x0 avalon1126.bin
```

### ISP режим K210

1. Подключите USB-UART к пинам TX/RX K210
2. Удерживайте кнопку BOOT при включении
3. Запустите kflash

---

## 🌐 API интерфейс

### Подключение

- **Порт**: 4028 (TCP)
- **Формат**: JSON
- **Совместимость**: CGMiner API 3.7

### Команды

| Команда | Описание |
|---------|----------|
| `version` | Версия CGMiner и API |
| `summary` | Общая статистика майнера |
| `pools` | Информация о пулах |
| `devs` | Информация об устройствах (ASIC) |
| `config` | Текущая конфигурация |
| `stats` | Детальная статистика |

### Примеры использования

```bash
# Получить версию
echo "version" | nc -w 1 192.168.1.100 4028

# Получить статистику
echo "summary" | nc -w 1 192.168.1.100 4028

# Информация о пулах
echo "pools" | nc -w 1 192.168.1.100 4028

# Информация об устройствах
echo "devs" | nc -w 1 192.168.1.100 4028
```

### Формат ответа

```json
{
  "STATUS": [{"STATUS":"S","Code":11}],
  "SUMMARY": [{
    "Elapsed": 3600,
    "GHS 5s": 50.00,
    "GHS av": 49.85,
    "Accepted": 1234,
    "Rejected": 5,
    "Hardware Errors": 2,
    "Pool Rejected%": 0.40
  }]
}
```

---

## ⚙️ Конфигурация

### Параметры ASIC (Avalon10)

| Параметр | По умолчанию | Диапазон | Описание |
|----------|--------------|----------|----------|
| Частота | 400 MHz | 400-500 MHz | Частота чипов |
| Напряжение | 780 mV | 700-900 mV | Напряжение ядра |
| Вентилятор мин | 10% | 0-100% | Минимальные обороты |
| Вентилятор макс | 100% | 0-100% | Максимальные обороты |
| Целевая температура | 75°C | 50-85°C | Целевая температура |
| Перегрев | 95°C | 80-105°C | Аварийное отключение |

### Сетевые настройки

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| DHCP | Включён | Автоматическое получение IP |
| IP адрес | 192.168.1.254 | Статический IP (если DHCP выключен) |
| Маска | 255.255.255.0 | Маска подсети |
| Шлюз | 192.168.1.1 | Шлюз по умолчанию |

### Настройки пулов

Поддерживается до 3 пулов с приоритетом (стратегия Failover):

```
Pool 1: stratum+tcp://pool1.example.com:3333 (приоритет 0)
Pool 2: stratum+tcp://pool2.example.com:3333 (приоритет 1)
Pool 3: stratum+tcp://pool3.example.com:3333 (приоритет 2)
```

---

## 🏗️ Архитектура прошивки

### Задачи FreeRTOS

| Задача | Приоритет | Стек | Описание |
|--------|-----------|------|----------|
| `watchdog` | 6 | 2KB | Сторожевой таймер |
| `stratum_send` | 5 | 4KB | Отправка данных на пул |
| `stratum_recv` | 5 | 4KB | Приём данных от пула |
| `mining` | 4 | 4KB | Отправка работы на ASIC |
| `monitor` | 4 | 4KB | Мониторинг температуры |
| `api_server` | 3 | 8KB | CGMiner API сервер |
| `http_server` | 3 | 8KB | Web-интерфейс |
| `led_control` | 2 | 1KB | Управление индикаторами |

### Архитектура модулей

```
┌─────────────────────────────────────────────────────────────────┐
│                      ПРИЛОЖЕНИЕ                                  │
├───────────────┬───────────────┬───────────────┬─────────────────┤
│    Stratum    │     Pool      │      API      │      HTTP       │
│   Protocol    │   Manager     │    Server     │     Server      │
│  (stratum.c)  │   (pool.c)    │   (api.c)     │                 │
├───────────────┴───────────────┴───────────────┴─────────────────┤
│                     WORK MANAGER (work.c)                        │
│              Формирование заголовка блока, SHA256d               │
├─────────────────────────────────────────────────────────────────┤
│                  AVALON10 DRIVER (avalon10.c)                    │
│          SPI связь с ASIC, PWM вентиляторы, термоконтроль        │
├─────────────────────────────────────────────────────────────────┤
│     NETWORK (network.c)    │    CONFIG (config.c)    │  W25QXX  │
│      lwIP + DM9051         │   Сохранение в flash    │  (flash) │
├────────────────────────────┴────────────────────────┴───────────┤
│                    MOCK HARDWARE (mock_hardware.c)               │
│            Эмуляция Flash, Network, ASIC для тестов              │
├─────────────────────────────────────────────────────────────────┤
│                        FreeRTOS                                  │
├─────────────────────────────────────────────────────────────────┤
│                   KENDRYTE K210 SDK/HAL                          │
│          SPI, I2C, GPIO, UART, PWM, DMA, SHA256                  │
└─────────────────────────────────────────────────────────────────┘
```

### Протокол связи с ASIC

Формат пакета (96 байт):
```
[0-1]   Magic (0x4156 = "AV")
[2]     Тип команды
[3]     Длина данных
[4-87]  Данные (до 84 байт)
[88-91] CRC32
```

Типы команд:
- `0x01` — Отправка работы (WORK)
- `0x10` — Nonce найден (NONCE)
- `0x11` — Запрос статуса (STATUS)
- `0x20` — Установка частоты (SET_FREQ)
- `0x21` — Установка напряжения (SET_VOLTAGE)
- `0x30` — Сброс модуля (RESET)
- `0x31` — Обнаружение модуля (DETECT)

---

## 📊 Сравнение с оригиналом

| Параметр | Оригинал (donor_dump.bin) | Наша сборка |
|----------|---------------------------|-------------|
| Размер файла | 8,388,608 байт | 362,924 байт |
| Формат | K210 flash dump | Kendryte SDK binary |
| RTOS | Минимальный | Полный FreeRTOS |
| Сетевой стек | Минимальный | Полный lwIP |
| Отладка | Нет | Есть (ELF + symbols) |
| Тестирование | Только на железе | Mock-режим |

---

## 📂 Описание исходных файлов

### main.c (~850 строк)
Точка входа прошивки. Инициализация оборудования K210, создание задач FreeRTOS.

### cgminer.h (~400 строк)
Общие определения: версии, константы, структуры `cgminer_config_t`, `work_t`.

### avalon10.c/h (~950/680 строк)
Драйвер ASIC: SPI связь с модулями, управление частотой/напряжением, мониторинг температуры, PWM вентиляторы.

### stratum.c/h (~760/130 строк)
Stratum протокол: JSON парсинг mining.notify/set_difficulty, формирование subscribe/authorize/submit.

### network.c/h (~560/170 строк)
Сетевой стек: lwIP интеграция, DM9051 Ethernet, TCP сокеты, DHCP.

### work.c/h (~370/90 строк)
Формирование заголовка блока Bitcoin (80 байт), вычисление Merkle Root через SHA256d.

### pool.c/h (~350/100 строк)
Управление пулами: подключение, переключение при сбоях, статистика.

### api.c/h (~390/70 строк)
CGMiner API сервер на порту 4028: version, summary, pools, devs, config, stats.

### config.c/h (~200/50 строк)
Чтение/запись конфигурации из SPI flash.

### w25qxx.c/h (~350/100 строк)
Драйвер SPI flash W25Q64: чтение, запись страниц, стирание секторов/блоков.

### mock_hardware.c/h (~650/260 строк)
Эмуляция оборудования для тестирования: flash 8MB, сокеты со Stratum ответами, 4 ASIC модуля, программный SHA256.

---

## 🔍 Реверс-инжиниринг

### Инструменты

- **Ghidra** — дизассемблирование и декомпиляция RISC-V
- **binwalk** — анализ структуры прошивки
- **strings** — извлечение строк

### Ключевые находки

1. **Строки CGMiner**: `cgminer 4.11.1`, `API 3.2`
2. **Модель**: `AvalonMiner 1126`, `AV10MM`
3. **Конфигурация**: `network.cfg`, `product.cfg`, `system.cfg`
4. **Функции**: 1,847 функций декомпилировано
5. **Протокол ASIC**: Формат пакетов восстановлен из FUN_ram_8000*

### Карта памяти K210

| Регион | Адрес | Размер | Описание |
|--------|-------|--------|----------|
| ROM | 0x00000000 | 128KB | Boot ROM |
| SRAM | 0x80000000 | 6MB | Основная память |
| AI SRAM | 0x80600000 | 2MB | KPU память |
| Flash | SPI | 8MB | W25Q64 SPI Flash |
| Peripheral | 0x50000000 | — | Регистры периферии |

---

## 📝 Лицензия

Проект основан на **CGMiner 4.11.1** и распространяется под лицензией **GPLv3**.

Kendryte SDK распространяется под лицензией Apache 2.0.

---

## 👥 Авторы

Восстановлено путём реверс-инжиниринга из оригинальной прошивки.

**Статистика кода**: ~7850 строк C-кода

---

## ⚠️ Отказ от ответственности

Данный проект предоставляется "как есть" без каких-либо гарантий. Используйте на свой страх и риск. Авторы не несут ответственности за любой ущерб, причинённый использованием данного программного обеспечения.

**Внимание**: Модификация прошивки может повредить оборудование или привести к потере гарантии.
