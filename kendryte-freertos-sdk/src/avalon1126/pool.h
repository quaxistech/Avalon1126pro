/**
 * =============================================================================
 * @file    pool.h
 * @brief   Avalon A1126pro - Управление пулами майнинга (заголовочный файл)
 * @version 1.0
 * @date    2024
 * =============================================================================
 * 
 * ОПИСАНИЕ:
 * Заголовочный файл модуля управления пулами майнинга.
 * Содержит структуры данных и прототипы функций для работы с пулами.
 * 
 * ФУНКЦИОНАЛЬНОСТЬ:
 * - Хранение информации о пулах (до 3 штук)
 * - Переключение между пулами (failover, round-robin, rotate)
 * - Статистика по каждому пулу
 * - Приоритеты пулов
 * 
 * =============================================================================
 */

#ifndef __POOL_H__
#define __POOL_H__

/* ===========================================================================
 * ПОДКЛЮЧАЕМЫЕ ФАЙЛЫ
 * =========================================================================== */

#include <stdint.h>
#include <stdbool.h>
#include <time.h>
#include "cgminer.h"

/* ===========================================================================
 * КОНСТАНТЫ
 * =========================================================================== */

/**
 * @brief Состояния подключения к пулу
 */
#define POOL_STATE_DISABLED     0   /* Пул отключён */
#define POOL_STATE_CONNECTING   1   /* Подключение */
#define POOL_STATE_CONNECTED    2   /* Подключён */
#define POOL_STATE_ACTIVE       3   /* Активен (майнинг) */
#define POOL_STATE_DEAD         4   /* Недоступен */

/**
 * @brief Таймауты (в секундах)
 */
#define POOL_CONNECT_TIMEOUT    30      /* Таймаут подключения */
#define POOL_RECONNECT_DELAY    30      /* Задержка переподключения */
#define POOL_DEAD_TIMEOUT       120     /* Время до признания пула мёртвым */

/* ===========================================================================
 * СТРУКТУРЫ ДАННЫХ
 * =========================================================================== */

/**
 * @struct pool_t
 * @brief Структура пула майнинга
 * 
 * Содержит всю информацию об одном пуле:
 * - Настройки подключения (URL, логин, пароль)
 * - Состояние соединения
 * - Статистика (принято, отклонено, хэшрейт)
 * - Параметры Stratum
 */
typedef struct pool {
    /* ------------------------------------------
     * Идентификация
     * ------------------------------------------ */
    int pool_no;                            /* Номер пула (0, 1, 2) */
    int priority;                           /* Приоритет (меньше = выше) */
    int enabled;                            /* 1 = пул включён */
    int state;                              /* Состояние (POOL_STATE_*) */
    
    /* ------------------------------------------
     * Настройки подключения
     * ------------------------------------------ */
    char url[MAX_URL_LEN];                  /* URL пула (stratum+tcp://...) */
    char user[MAX_USER_LEN];                /* Имя пользователя (wallet.worker) */
    char pass[MAX_PASS_LEN];                /* Пароль */
    char host[MAX_URL_LEN];                 /* Хост (без протокола) */
    int port;                               /* Порт */
    
    /* ------------------------------------------
     * Состояние Stratum
     * ------------------------------------------ */
    int stratum_active;                     /* 1 = Stratum соединение активно */
    int stratum_auth;                       /* 1 = авторизован */
    int sock;                               /* Сокет соединения */
    
    /* ------------------------------------------
     * Параметры Stratum
     * ------------------------------------------ */
    char session_id[64];                    /* ID сессии */
    char extranonce1[32];                   /* ExtraNonce1 от пула */
    int extranonce1_len;                    /* Длина ExtraNonce1 */
    int extranonce2_len;                    /* Длина ExtraNonce2 */
    double diff;                            /* Текущая сложность */
    double sdiff;                           /* Сложность шары */
    
    /* ------------------------------------------
     * Текущая работа
     * ------------------------------------------ */
    char job_id[MAX_JOB_ID_LEN];            /* ID текущего задания */
    uint8_t prevhash[32];                   /* Хэш предыдущего блока */
    uint32_t ntime;                         /* Время блока */
    uint32_t version;                       /* Версия блока */
    
    /* ------------------------------------------
     * Статистика
     * ------------------------------------------ */
    uint64_t accepted;                      /* Принятые шары */
    uint64_t rejected;                      /* Отклонённые шары */
    uint64_t stale;                         /* Устаревшие шары */
    uint64_t getworks;                      /* Количество полученных заданий */
    double total_diff;                      /* Суммарная сложность */
    
    /* ------------------------------------------
     * Временные метки
     * ------------------------------------------ */
    time_t last_work_time;                  /* Время последнего задания */
    time_t last_submit_time;                /* Время последней отправки */
    time_t connect_time;                    /* Время подключения */
    time_t last_fail;                       /* Время последнего сбоя */
    
    /* ------------------------------------------
     * Счётчики
     * ------------------------------------------ */
    int seq_getwork;                        /* Последовательный номер getwork */
    int seq_submit;                         /* Последовательный номер submit */
    int fail_count;                         /* Счётчик сбоев подряд */
    
    /* ------------------------------------------
     * Буферы данных
     * ------------------------------------------ */
    char recv_buf[BUFFER_SIZE];             /* Буфер приёма */
    int recv_buf_len;                       /* Длина данных в буфере */
} pool_t;

/* ===========================================================================
 * ВНЕШНИЕ ПЕРЕМЕННЫЕ
 * =========================================================================== */

extern pool_t g_pools[MAX_POOLS];           /* Массив пулов */
extern int g_pool_count;                    /* Количество пулов */
extern pool_t *g_current_pool;              /* Текущий активный пул */

/* ===========================================================================
 * ПРОТОТИПЫ ФУНКЦИЙ
 * =========================================================================== */

/* ---------------------------------------------------------------------------
 * Инициализация и управление
 * --------------------------------------------------------------------------- */

/**
 * @brief Инициализация модуля пулов
 */
void pool_init(void);

/**
 * @brief Добавление нового пула
 * 
 * @param url   URL пула (stratum+tcp://host:port)
 * @param user  Имя пользователя
 * @param pass  Пароль
 * @return      Указатель на пул или NULL при ошибке
 */
pool_t *add_pool(const char *url, const char *user, const char *pass);

/**
 * @brief Удаление пула
 * 
 * @param pool_no   Номер пула
 * @return          0 при успехе
 */
int remove_pool(int pool_no);

/**
 * @brief Включение пула
 * 
 * @param pool_no   Номер пула
 */
void enable_pool(int pool_no);

/**
 * @brief Отключение пула
 * 
 * @param pool_no   Номер пула
 */
void disable_pool(int pool_no);

/* ---------------------------------------------------------------------------
 * Подключение
 * --------------------------------------------------------------------------- */

/**
 * @brief Подключение к пулу
 * 
 * @param pool  Указатель на пул
 * @return      0 при успехе
 */
int connect_pool(pool_t *pool);

/**
 * @brief Отключение от пула
 * 
 * @param pool  Указатель на пул
 */
void disconnect_pool(pool_t *pool);

/**
 * @brief Переподключение к пулу
 * 
 * @param pool  Указатель на пул
 * @return      0 при успехе
 */
int reconnect_pool(pool_t *pool);

/* ---------------------------------------------------------------------------
 * Выбор пула
 * --------------------------------------------------------------------------- */

/**
 * @brief Получение текущего активного пула
 * 
 * @return  Указатель на текущий пул
 */
pool_t *get_current_pool(void);

/**
 * @brief Переключение на следующий пул
 * 
 * @return  Указатель на новый текущий пул
 */
pool_t *switch_pool(void);

/**
 * @brief Выбор лучшего пула по стратегии
 * 
 * @return  Указатель на выбранный пул
 */
pool_t *select_best_pool(void);

/* ---------------------------------------------------------------------------
 * Статистика
 * --------------------------------------------------------------------------- */

/**
 * @brief Получение общей статистики по всем пулам
 * 
 * @param accepted  Указатель для записи принятых
 * @param rejected  Указатель для записи отклонённых
 */
void get_pool_stats(uint64_t *accepted, uint64_t *rejected);

/**
 * @brief Сброс статистики пула
 * 
 * @param pool  Указатель на пул
 */
void reset_pool_stats(pool_t *pool);

#endif /* __POOL_H__ */

/* ===========================================================================
 * КОНЕЦ ФАЙЛА pool.h
 * =========================================================================== */
