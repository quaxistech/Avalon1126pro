/**
 * =============================================================================
 * @file    avalon10.h
 * @brief   Avalon A1126pro - Драйвер ASIC Avalon10 (заголовочный файл)
 * @version 1.0
 * @date    2024
 * =============================================================================
 * 
 * ОПИСАНИЕ:
 * Заголовочный файл драйвера ASIC чипов Avalon10 для майнера A1126pro.
 * Содержит константы, структуры данных и прототипы функций для управления
 * ASIC модулями.
 * 
 * ХАРАКТЕРИСТИКИ ASIC AVALON10:
 * - Количество модулей: до 4
 * - Чипов на модуль: 114
 * - Ядер на чип: 72
 * - Всего ядер: 4 × 114 × 72 = 32,832
 * - Интерфейс: SPI
 * - Хэшрейт: ~50 TH/s на модуль
 * 
 * ОРИГИНАЛЬНЫЕ ДАННЫЕ:
 * Значения констант получены из декомпиляции donor_dump.bin.
 * Формат пакетов восстановлен из функций FUN_ram_8000*.
 * 
 * =============================================================================
 */

#ifndef __AVALON10_H__
#define __AVALON10_H__

/* ===========================================================================
 * ПОДКЛЮЧАЕМЫЕ ЗАГОЛОВОЧНЫЕ ФАЙЛЫ
 * =========================================================================== */

#include <stdint.h>         /* Типы данных фиксированного размера */
#include <stdbool.h>        /* Булевы типы */
#include "cgminer.h"        /* Общие определения CGMiner */

/* ===========================================================================
 * КОНСТАНТЫ АППАРАТНОЙ КОНФИГУРАЦИИ
 * 
 * Значения получены из анализа декомпилированного кода.
 * Эти параметры специфичны для Avalon A1126pro.
 * =========================================================================== */

/* ---------------------------------------------------------------------------
 * Конфигурация модулей и чипов
 * --------------------------------------------------------------------------- */

/**
 * @brief Максимальное количество модулей (хэш-плат)
 * A1126pro содержит 4 модуля в корпусе
 * Оригинальный адрес: константа в FUN_ram_80004e86
 */
#define AVALON10_DEFAULT_MODULARS       4

/**
 * @brief Количество чипов на модуль
 * Avalon10 использует 114 ASIC чипов на плату
 * Оригинальный адрес: FUN_ram_80005184 (множитель 0x72 = 114)
 */
#define AVALON10_DEFAULT_MINER_CNT      114

/**
 * @brief Количество ядер (cores) в одном чипе
 * Каждый ASIC чип содержит 72 вычислительных ядра
 */
#define AVALON10_DEFAULT_ASIC_CORE      72

/**
 * @brief Общее количество ядер на модуль
 * 114 чипов × 72 ядра = 8,208 ядер
 */
#define AVALON10_CORES_PER_MODULE       (AVALON10_DEFAULT_MINER_CNT * AVALON10_DEFAULT_ASIC_CORE)

/**
 * @brief Общее количество ядер в майнере
 * 4 модуля × 8,208 = 32,832 ядра
 */
#define AVALON10_TOTAL_CORES            (AVALON10_DEFAULT_MODULARS * AVALON10_CORES_PER_MODULE)

/* ---------------------------------------------------------------------------
 * Настройки частоты (в MHz)
 * --------------------------------------------------------------------------- */

/**
 * @brief Минимальная рабочая частота
 * Найдено в декомпиляции: 400 MHz (0x190)
 */
#define AVALON10_DEFAULT_FREQ_MIN       400

/**
 * @brief Максимальная рабочая частота
 * Найдено в декомпиляции: 500 MHz (0x1F4)
 */
#define AVALON10_DEFAULT_FREQ_MAX       500

/**
 * @brief Шаг изменения частоты
 * Частота меняется с шагом 25 MHz
 */
#define AVALON10_FREQ_STEP              25

/**
 * @brief Количество слотов частот
 * Для плавной регулировки в зависимости от температуры
 */
#define AVALON10_FREQ_SLOTS             5

/* ---------------------------------------------------------------------------
 * Настройки напряжения (в mV)
 * --------------------------------------------------------------------------- */

/**
 * @brief Напряжение ядра по умолчанию
 * 780 mV = оптимальное соотношение производительность/потребление
 * Найдено: 0x30C = 780
 */
#define AVALON10_DEFAULT_VOLTAGE        780

/**
 * @brief Минимальное напряжение ядра
 * Ниже 700 mV работа нестабильна
 */
#define AVALON10_VOLTAGE_MIN            700

/**
 * @brief Максимальное напряжение ядра
 * Выше 900 mV риск повреждения чипов
 */
#define AVALON10_VOLTAGE_MAX            900

/**
 * @brief Шаг изменения напряжения
 */
#define AVALON10_VOLTAGE_STEP           10

/* ---------------------------------------------------------------------------
 * Настройки вентиляторов (в процентах)
 * --------------------------------------------------------------------------- */

/**
 * @brief Минимальная скорость вентилятора (%)
 * Даже в простое вентиляторы крутятся на 10%
 */
#define AVALON10_DEFAULT_FAN_MIN        10

/**
 * @brief Максимальная скорость вентилятора (%)
 * 100% = максимальные обороты
 */
#define AVALON10_DEFAULT_FAN_MAX        100

/**
 * @brief Количество вентиляторов
 * A1126pro имеет 2 вентилятора
 */
#define AVALON10_FAN_COUNT              2

/* ---------------------------------------------------------------------------
 * Настройки температуры (в градусах Цельсия)
 * --------------------------------------------------------------------------- */

/**
 * @brief Целевая температура
 * PID-регулятор поддерживает эту температуру
 * Найдено: 75°C (0x4B)
 */
#define AVALON10_DEFAULT_TEMP_TARGET    75

/**
 * @brief Температура перегрева (предупреждение)
 * При достижении снижается частота
 */
#define AVALON10_DEFAULT_TEMP_OVERHEAT  95

/**
 * @brief Температура отключения (критическая)
 * При достижении майнинг останавливается
 */
#define AVALON10_DEFAULT_TEMP_CUTOFF    105

/**
 * @brief Количество датчиков температуры на модуль
 */
#define AVALON10_TEMP_SENSORS_PER_MODULE    2

/**
 * @brief Общее количество датчиков температуры
 */
#define AVALON10_TEMP_SENSORS_TOTAL     (AVALON10_DEFAULT_MODULARS * AVALON10_TEMP_SENSORS_PER_MODULE)

/* ---------------------------------------------------------------------------
 * Протокол связи с ASIC
 * --------------------------------------------------------------------------- */

/**
 * @brief Базовая длина пакета
 * Размер пакета CGMiner Avalon4+ протокола: 40 байт
 * Оригинальный адрес: FUN_ram_8000a1b2 (константа 40)
 */
#define AVALON10_PKT_BASE_LEN           40

/**
 * @brief Полная длина пакета (совпадает с базовой в Avalon протоколе)
 */
#define AVALON10_PKT_TOTAL_LEN          40

/**
 * @brief Максимальная длина данных в пакете
 * В протоколе Avalon - фиксированные 32 байта
 */
#define AVALON10_PKT_MAX_DATA           32

/**
 * @brief Заголовок пакета - первый байт 'C'
 */
#define AVALON10_PKT_HEAD1              'C'

/**
 * @brief Заголовок пакета - второй байт 'N' 
 */
#define AVALON10_PKT_HEAD2              'N'

/**
 * @brief Сигнатура пакета (magic number) - deprecated
 * Оставлено для совместимости, используйте AVALON10_PKT_HEAD1/HEAD2
 */
#define AVALON10_PKT_MAGIC              0x4E43  /* 'CN' little-endian */

/* ---------------------------------------------------------------------------
 * Типы пакетов (команды)
 * Найдены в декомпиляции: switch в FUN_ram_80004f14
 * --------------------------------------------------------------------------- */

/**
 * @brief Отправка рабочего задания на ASIC
 * Содержит заголовок блока для майнинга
 */
#define AVALON10_P_WORK                 0x01

/**
 * @brief Отправка работы на конкретный чип
 */
#define AVALON10_P_WORK_TO_CHIP         0x02

/**
 * @brief Результат вычисления (nonce)
 * ASIC возвращает найденный nonce
 */
#define AVALON10_P_NONCE                0x10

/**
 * @brief Получение статуса модуля
 * Возвращает температуру, частоту, состояние
 */
#define AVALON10_P_STATUS               0x11

/**
 * @brief Установка частоты чипа
 */
#define AVALON10_P_SET_FREQ             0x20

/**
 * @brief Установка напряжения ядра
 */
#define AVALON10_P_SET_VOLTAGE          0x21

/**
 * @brief Установка скорости вентилятора
 */
#define AVALON10_P_SET_FAN              0x22

/**
 * @brief Запуск/остановка майнинга
 */
#define AVALON10_P_SET_MINING           0x23

/**
 * @brief Сброс модуля
 */
#define AVALON10_P_RESET                0x30

/**
 * @brief Обнаружение модулей
 */
#define AVALON10_P_DETECT               0x31

/**
 * @brief Чтение информации о чипе
 */
#define AVALON10_P_READ_REG             0x32

/**
 * @brief Запись в регистр чипа
 */
#define AVALON10_P_WRITE_REG            0x33

/**
 * @brief Тестовый пакет
 */
#define AVALON10_P_TEST                 0xFF

/* ---------------------------------------------------------------------------
 * Состояния модуля
 * --------------------------------------------------------------------------- */

/**
 * @brief Модуль не обнаружен
 */
#define AVALON10_MODULE_STATE_NONE      0

/**
 * @brief Модуль инициализируется
 */
#define AVALON10_MODULE_STATE_INIT      1

/**
 * @brief Модуль готов к работе
 */
#define AVALON10_MODULE_STATE_READY     2

/**
 * @brief Модуль майнит
 */
#define AVALON10_MODULE_STATE_MINING    3

/**
 * @brief Ошибка модуля
 */
#define AVALON10_MODULE_STATE_ERROR     4

/**
 * @brief Модуль перегрелся
 */
#define AVALON10_MODULE_STATE_OVERHEAT  5

/* ---------------------------------------------------------------------------
 * Таймауты (в миллисекундах)
 * --------------------------------------------------------------------------- */

/**
 * @brief Таймаут опроса модуля
 */
#define AVALON10_POLL_TIMEOUT_MS        100

/**
 * @brief Таймаут приёма nonce
 */
#define AVALON10_NONCE_TIMEOUT_MS       10

/**
 * @brief Таймаут сброса модуля
 */
#define AVALON10_RESET_TIMEOUT_MS       5000

/**
 * @brief Интервал обновления статистики
 */
#define AVALON10_STATS_INTERVAL_MS      1000

/* ===========================================================================
 * СТРУКТУРЫ ДАННЫХ
 * =========================================================================== */

/**
 * @struct avalon10_chip_t
 * @brief Информация об одном ASIC чипе
 * 
 * Хранит состояние и статистику отдельного чипа.
 */
typedef struct avalon10_chip {
    uint8_t chip_id;            /* ID чипа (0-113) */
    uint8_t enabled;            /* 1 = чип активен */
    uint8_t error_count;        /* Счётчик ошибок */
    
    uint16_t freq;              /* Текущая частота (MHz) */
    int16_t temp;               /* Температура чипа (°C × 10) */
    
    uint32_t nonces;            /* Количество найденных nonce */
    uint32_t hw_errors;         /* Аппаратные ошибки */
} avalon10_chip_t;

/**
 * @struct avalon10_module_t
 * @brief Информация о модуле (хэш-плате)
 * 
 * Один модуль содержит AVALON10_DEFAULT_MINER_CNT чипов.
 * A1126pro имеет 4 таких модуля.
 */
typedef struct avalon10_module {
    /* ------------------------------------------
     * Идентификация
     * ------------------------------------------ */
    uint8_t module_id;              /* ID модуля (0-3) */
    uint8_t state;                  /* Состояние (AVALON10_MODULE_STATE_*) */
    uint8_t enabled;                /* 1 = модуль активен */
    
    /* ------------------------------------------
     * Настройки
     * ------------------------------------------ */
    uint16_t freq[AVALON10_FREQ_SLOTS];     /* Частоты по слотам */
    uint16_t voltage;                        /* Напряжение (mV) */
    uint8_t fan_speed;                       /* Скорость вентилятора (%) */
    
    /* ------------------------------------------
     * Температура
     * ------------------------------------------ */
    int16_t temp_in;                /* Входная температура (°C × 10) */
    int16_t temp_out;               /* Выходная температура (°C × 10) */
    int16_t temp_max;               /* Максимальная температура */
    int16_t temp_avg;               /* Средняя температура */
    
    /* ------------------------------------------
     * Статистика
     * ------------------------------------------ */
    uint64_t hashrate;              /* Текущий хэшрейт (H/s) */
    uint64_t hashrate_avg;          /* Средний хэшрейт */
    uint32_t accepted;              /* Принятые шары */
    uint32_t rejected;              /* Отклонённые шары */
    uint32_t hw_errors;             /* Аппаратные ошибки */
    uint32_t stale;                 /* Устаревшие шары */
    
    /* ------------------------------------------
     * Информация о чипах
     * ------------------------------------------ */
    avalon10_chip_t chips[AVALON10_DEFAULT_MINER_CNT];
    uint8_t active_chips;           /* Количество активных чипов */
    uint8_t failed_chips;           /* Количество сбойных чипов */
    
    /* ------------------------------------------
     * Служебные данные
     * ------------------------------------------ */
    uint32_t last_poll;             /* Время последнего опроса */
    uint8_t poll_errors;            /* Ошибки опроса подряд */
} avalon10_module_t;

/**
 * @struct avalon10_info_t
 * @brief Главная структура информации Avalon10
 * 
 * Содержит информацию обо всех модулях майнера,
 * глобальные настройки и статистику.
 */
typedef struct avalon10_info {
    /* ------------------------------------------
     * Модули
     * ------------------------------------------ */
    avalon10_module_t modules[AVALON10_DEFAULT_MODULARS];
    uint8_t module_count;           /* Количество обнаруженных модулей */
    uint8_t active_modules;         /* Количество активных модулей */
    
    /* ------------------------------------------
     * Настройки по умолчанию
     * ------------------------------------------ */
    uint16_t default_freq[2];       /* Диапазон частот [min, max] */
    uint16_t default_voltage;       /* Напряжение по умолчанию */
    uint8_t fan_min;                /* Минимальная скорость вентилятора */
    uint8_t fan_max;                /* Максимальная скорость вентилятора */
    int8_t temp_target;             /* Целевая температура */
    int8_t temp_overheat;           /* Температура перегрева */
    int8_t temp_cutoff;             /* Температура отключения */
    
    /* ------------------------------------------
     * Текущие вентиляторы
     * ------------------------------------------ */
    uint16_t fan_rpm[AVALON10_FAN_COUNT];   /* Обороты вентиляторов */
    uint8_t fan_pwm[AVALON10_FAN_COUNT];    /* ШИМ вентиляторов (%) */
    
    /* ------------------------------------------
     * Глобальная статистика
     * ------------------------------------------ */
    uint64_t total_hashrate;        /* Общий хэшрейт (H/s) */
    uint64_t total_accepted;        /* Всего принято */
    uint64_t total_rejected;        /* Всего отклонено */
    uint64_t total_hw_errors;       /* Всего HW ошибок */
    
    /* ------------------------------------------
     * Состояние
     * ------------------------------------------ */
    uint8_t mining_enabled;         /* 1 = майнинг разрешён */
    uint8_t overheat;               /* 1 = перегрев */
    uint8_t initialized;            /* 1 = инициализирован */
    
    /* ------------------------------------------
     * Служебные данные
     * ------------------------------------------ */
    uint32_t uptime;                /* Время работы (секунды) */
    uint32_t last_update;           /* Время последнего обновления */
    
    /* ------------------------------------------
     * Текущая работа
     * ------------------------------------------ */
    work_t *current_work;           /* Текущее задание */
    uint32_t work_id;               /* ID текущей работы */
} avalon10_info_t;

/**
 * @struct avalon10_pkg_t
 * @brief Структура пакета для связи с ASIC
 * 
 * Формат пакета (совместим с CGMiner Avalon4+ протоколом):
 * [0-1]   - Head ('C', 'N' = 0x434E)
 * [2]     - Type - тип пакета
 * [3]     - Opt - опция/параметр  
 * [4]     - Idx - индекс
 * [5]     - Cnt - счётчик
 * [6-37]  - Data[32] - данные
 * [38-39] - CRC16 (CCITT)
 * 
 * ВАЖНО: Avalon протокол использует CRC16-CCITT (poly 0x1021), НЕ CRC32!
 */
typedef struct avalon10_pkg {
    uint8_t head[2];                /* Заголовок ('C', 'N') */
    uint8_t type;                   /* Тип пакета (AVALON10_P_*) */
    uint8_t opt;                    /* Опция/параметр */
    uint8_t idx;                    /* Индекс пакета */
    uint8_t cnt;                    /* Счётчик пакетов */
    uint8_t data[32];               /* Данные (32 байта) */
    uint8_t crc[2];                 /* CRC16-CCITT */
} __attribute__((packed)) avalon10_pkg_t;

/* Размер пакета */
#define AVALON10_PKG_SIZE       sizeof(avalon10_pkg_t)  /* 40 байт */

/* Размер данных в пакете */
#define AVALON10_PKG_DATA_LEN   32

/* ===========================================================================
 * ПРОТОТИПЫ ФУНКЦИЙ
 * =========================================================================== */

/* ---------------------------------------------------------------------------
 * Инициализация и управление
 * --------------------------------------------------------------------------- */

/**
 * @brief Инициализация драйвера Avalon10
 * 
 * Обнаруживает модули, инициализирует чипы, применяет настройки.
 * 
 * @param info      Указатель на структуру информации
 * @return          0 при успехе, отрицательное значение при ошибке
 */
int avalon10_init(avalon10_info_t *info);

/**
 * @brief Деинициализация драйвера
 * 
 * Останавливает майнинг, освобождает ресурсы.
 * 
 * @param info      Указатель на структуру информации
 */
void avalon10_exit(avalon10_info_t *info);

/**
 * @brief Сброс модуля
 * 
 * @param info      Указатель на структуру информации
 * @param module_id ID модуля для сброса (-1 = все)
 * @return          0 при успехе
 */
int avalon10_reset(avalon10_info_t *info, int module_id);

/* ---------------------------------------------------------------------------
 * Опрос и статистика
 * --------------------------------------------------------------------------- */

/**
 * @brief Опрос всех модулей
 * 
 * Собирает nonce, обновляет статистику.
 * Вызывается в основном цикле майнинга.
 * 
 * @param info      Указатель на структуру информации
 * @return          Количество найденных nonce
 */
int avalon10_poll(avalon10_info_t *info);

/**
 * @brief Чтение температуры со всех датчиков
 * 
 * @param info      Указатель на структуру информации
 * @return          Максимальная температура
 */
int avalon10_read_temperature(avalon10_info_t *info);

/**
 * @brief Проверка перегрева
 * 
 * При превышении порога снижает частоту или останавливает майнинг.
 * 
 * @param info      Указатель на структуру информации
 */
void avalon10_check_overheat(avalon10_info_t *info);

/**
 * @brief Расчёт и обновление хэшрейта
 * 
 * @param info      Указатель на структуру информации
 */
void avalon10_update_hashrate(avalon10_info_t *info);

/* ---------------------------------------------------------------------------
 * Управление вентиляторами
 * --------------------------------------------------------------------------- */

/**
 * @brief Регулировка скорости вентиляторов
 * 
 * Использует PID-регулятор для поддержания целевой температуры.
 * 
 * @param info      Указатель на структуру информации
 */
void avalon10_adjust_fan(avalon10_info_t *info);

/**
 * @brief Установка скорости вентилятора
 * 
 * @param info      Указатель на структуру информации
 * @param fan_id    ID вентилятора (0 или 1)
 * @param speed     Скорость (0-100%)
 * @return          0 при успехе
 */
int avalon10_set_fan_speed(avalon10_info_t *info, int fan_id, int speed);

/* ---------------------------------------------------------------------------
 * Управление частотой и напряжением
 * --------------------------------------------------------------------------- */

/**
 * @brief Установка частоты модуля
 * 
 * @param info      Указатель на структуру информации
 * @param module_id ID модуля (-1 = все)
 * @param freq      Частота (MHz)
 * @return          0 при успехе
 */
int avalon10_set_freq(avalon10_info_t *info, int module_id, int freq);

/**
 * @brief Установка напряжения модуля
 * 
 * @param info      Указатель на структуру информации
 * @param module_id ID модуля (-1 = все)
 * @param voltage   Напряжение (mV)
 * @return          0 при успехе
 */
int avalon10_set_voltage(avalon10_info_t *info, int module_id, int voltage);

/* ---------------------------------------------------------------------------
 * Работа с заданиями
 * --------------------------------------------------------------------------- */

/**
 * @brief Отправка работы на все модули
 * 
 * @param info      Указатель на структуру информации
 * @param work      Указатель на рабочее задание
 * @return          0 при успехе
 */
int avalon10_send_work(avalon10_info_t *info, work_t *work);

/**
 * @brief Проверка nonce
 * 
 * Проверяет, удовлетворяет ли найденный nonce сложности.
 * 
 * @param work      Указатель на рабочее задание
 * @param nonce     Найденный nonce
 * @return          1 если nonce валиден, 0 иначе
 */
int avalon10_check_nonce(work_t *work, uint32_t nonce);

/* ---------------------------------------------------------------------------
 * Отладка
 * --------------------------------------------------------------------------- */

/**
 * @brief Вывод статистики модуля в лог
 * 
 * @param info      Указатель на структуру информации
 * @param module_id ID модуля
 */
void avalon10_print_stats(avalon10_info_t *info, int module_id);

/**
 * @brief Получение строки состояния модуля
 * 
 * @param state     Код состояния
 * @return          Строка состояния
 */
const char *avalon10_state_str(int state);

#endif /* __AVALON10_H__ */

/* ===========================================================================
 * КОНЕЦ ФАЙЛА avalon10.h
 * =========================================================================== */
