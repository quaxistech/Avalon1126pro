/**
 * =============================================================================
 * @file    cgminer.h
 * @brief   Avalon A1126pro - Общие определения CGMiner
 * @version 1.0
 * @date    2024
 * =============================================================================
 * 
 * ОПИСАНИЕ:
 * Заголовочный файл с общими определениями, константами и структурами данных
 * для прошивки майнера Avalon A1126pro на базе CGMiner 4.11.1.
 * 
 * Этот файл включается во все модули проекта и содержит:
 * - Версии прошивки и протоколов
 * - Уровни логирования
 * - Стратегии выбора пулов
 * - Общую структуру конфигурации
 * - Прототипы глобальных функций
 * 
 * =============================================================================
 */

#ifndef __CGMINER_H__
#define __CGMINER_H__

/* ===========================================================================
 * ПОДКЛЮЧАЕМЫЕ ЗАГОЛОВОЧНЫЕ ФАЙЛЫ
 * =========================================================================== */

#include <stdint.h>         /* Типы с фиксированным размером: uint8_t, uint32_t и т.д. */
#include <stdarg.h>         /* Поддержка переменного числа аргументов (va_list) */
#include <stdbool.h>        /* Тип bool в C99 */
#include <time.h>           /* Работа со временем: time_t */

/* FreeRTOS */
#include <FreeRTOS.h>
#include <semphr.h>         /* Семафоры и мьютексы */

/* ===========================================================================
 * ВЕРСИИ ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ
 * 
 * Строки версий найдены в оригинальной прошивке при анализе бинарника.
 * Команда: strings donor_dump.bin | grep -i version
 * =========================================================================== */

/**
 * @brief Версия CGMiner
 * Найдена в декомпиляции: "cgminer 4.11.1"
 */
#define CGMINER_VERSION     "4.11.1"

/**
 * @brief Версия прошивки Avalon A1126pro
 * Найдена в декомпиляции: "1.0.0"
 */
#define FIRMWARE_VERSION    "1.0.0"

/* ===========================================================================
 * УРОВНИ ЛОГИРОВАНИЯ (SYSLOG STYLE)
 * 
 * Стандартные уровни согласно syslog (RFC 5424).
 * Меньшее значение = более важное сообщение.
 * Используются для фильтрации вывода отладочной информации.
 * =========================================================================== */

#define LOG_EMERG       0   /* Система неработоспособна (аварийное) */
#define LOG_ALERT       1   /* Требуется немедленное вмешательство */
#define LOG_CRIT        2   /* Критическая ошибка */
#define LOG_ERR         3   /* Ошибка */
#define LOG_WARNING     4   /* Предупреждение */
#define LOG_NOTICE      5   /* Важное уведомление */
#define LOG_INFO        6   /* Информационное сообщение */
#define LOG_DEBUG       7   /* Отладочная информация */

/* ===========================================================================
 * ЛИМИТЫ И РАЗМЕРЫ
 * 
 * Значения определены из анализа декомпилированного кода.
 * Найдены при анализе размеров буферов и массивов.
 * =========================================================================== */

/**
 * @brief Максимальное количество пулов майнинга
 * A1126pro поддерживает до 3 пулов с приоритетом
 */
#define MAX_POOLS           3

/**
 * @brief Максимальная длина URL пула
 * Например: "stratum+tcp://pool.example.com:3333"
 */
#define MAX_URL_LEN         256

/**
 * @brief Максимальная длина имени пользователя
 * Формат: "wallet.worker"
 */
#define MAX_USER_LEN        128

/**
 * @brief Максимальная длина пароля
 * Обычно "x" или "d=difficulty"
 */
#define MAX_PASS_LEN        128

/**
 * @brief Максимальная длина Job ID
 * Уникальный идентификатор задания от пула
 */
#define MAX_JOB_ID_LEN      64

/**
 * @brief Максимальный размер буфера приёма/передачи
 * Для Stratum и API сообщений
 */
#define BUFFER_SIZE         4096

/* ===========================================================================
 * СТРАТЕГИИ ВЫБОРА ПУЛА
 * 
 * Определяют, как майнер выбирает пул при наличии нескольких.
 * Найдены в декомпиляции CGMiner.
 * =========================================================================== */

/**
 * @brief Failover - переключение при сбое
 * Использует первый пул, при его недоступности - второй, и т.д.
 * Наиболее распространённая стратегия.
 */
#define POOL_STRATEGY_FAILOVER      0

/**
 * @brief Round Robin - циклический перебор
 * Переключается между пулами по очереди.
 */
#define POOL_STRATEGY_ROUND_ROBIN   1

/**
 * @brief Rotate - ротация с интервалом
 * Переключается между пулами через заданный интервал времени.
 */
#define POOL_STRATEGY_ROTATE        2

/**
 * @brief Load Balance - балансировка нагрузки
 * Распределяет работу между пулами пропорционально.
 */
#define POOL_STRATEGY_LOAD_BALANCE  3

/**
 * @brief Balance - баланс по хэшрейту
 * Распределяет хэшрейт равномерно между пулами.
 */
#define POOL_STRATEGY_BALANCE       4

/* ===========================================================================
 * КОДЫ ОШИБОК
 * 
 * Используются для возврата состояния из функций.
 * =========================================================================== */

#define ERR_OK              0   /* Успешно */
#define ERR_FAIL           -1   /* Общая ошибка */
#define ERR_TIMEOUT        -2   /* Таймаут */
#define ERR_MEMORY         -3   /* Ошибка памяти */
#define ERR_NETWORK        -4   /* Сетевая ошибка */
#define ERR_INVALID        -5   /* Неверные данные */
#define ERR_NOTFOUND       -6   /* Не найдено */
#define ERR_BUSY           -7   /* Занято */
#define ERR_DISCONNECTED   -8   /* Отключено */

/* ===========================================================================
 * МАКРОСЫ УТИЛИТ
 * =========================================================================== */

/**
 * @brief Минимум из двух значений
 */
#ifndef MIN
#define MIN(a, b)   ((a) < (b) ? (a) : (b))
#endif

/**
 * @brief Максимум из двух значений
 */
#ifndef MAX
#define MAX(a, b)   ((a) > (b) ? (a) : (b))
#endif

/**
 * @brief Размер массива
 */
#define ARRAY_SIZE(x)   (sizeof(x) / sizeof((x)[0]))

/**
 * @brief Выравнивание вверх
 */
#define ALIGN_UP(x, align)  (((x) + (align) - 1) & ~((align) - 1))

/* ===========================================================================
 * СТРУКТУРЫ ДАННЫХ
 * =========================================================================== */

/**
 * @struct cgminer_config_t
 * @brief Глобальная конфигурация CGMiner
 * 
 * Структура хранит все настройки майнера.
 * Загружается из flash-памяти при старте.
 * Сохраняется при изменении через API.
 * 
 * Поля найдены при анализе декомпилированного кода и конфигурационных файлов.
 */
typedef struct cgminer_config {
    /* ------------------------------------------
     * Сетевые настройки
     * ------------------------------------------ */
    int dhcp_enabled;                       /* 1 = использовать DHCP */
    uint8_t ip_addr[4];                     /* Статический IP (если DHCP выкл) */
    uint8_t netmask[4];                     /* Маска подсети */
    uint8_t gateway[4];                     /* Шлюз по умолчанию */
    uint8_t dns[4];                         /* DNS сервер */
    uint8_t mac_addr[6];                    /* MAC адрес */
    
    /* ------------------------------------------
     * Настройки API сервера
     * ------------------------------------------ */
    int api_port;                           /* Порт API (по умолчанию 4028) */
    int api_listen;                         /* 1 = слушать на всех интерфейсах */
    int api_allow_write;                    /* 1 = разрешить запись */
    char api_allow[256];                    /* Разрешённые IP (0.0.0.0 = все) */
    
    /* ------------------------------------------
     * Настройки HTTP сервера
     * ------------------------------------------ */
    int http_port;                          /* Порт HTTP (по умолчанию 80) */
    int http_enabled;                       /* 1 = включён */
    
    /* ------------------------------------------
     * Настройки пулов (до 3 штук)
     * ------------------------------------------ */
    char pool_url[MAX_POOLS][MAX_URL_LEN];      /* URL пулов */
    char pool_user[MAX_POOLS][MAX_USER_LEN];    /* Пользователи */
    char pool_pass[MAX_POOLS][MAX_PASS_LEN];    /* Пароли */
    int pool_priority[MAX_POOLS];               /* Приоритеты */
    
    /* ------------------------------------------
     * Настройки ASIC
     * ------------------------------------------ */
    int freq[2];                            /* Диапазон частот [min, max] */
    int voltage;                            /* Напряжение ядра (mV) */
    int fan_min;                            /* Минимальная скорость вентилятора (%) */
    int fan_max;                            /* Максимальная скорость вентилятора (%) */
    int temp_target;                        /* Целевая температура (°C) */
    int temp_overheat;                      /* Температура перегрева (°C) */
    int temp_cutoff;                        /* Температура отключения (°C) */
    
    /* ------------------------------------------
     * Системные настройки
     * ------------------------------------------ */
    int log_level;                          /* Уровень логирования */
    int debug;                              /* Режим отладки */
    int pool_strategy;                      /* Стратегия выбора пула */
    int rotate_interval;                    /* Интервал ротации пулов (сек) */
    
    /* ------------------------------------------
     * Флаги конфигурации
     * ------------------------------------------ */
    uint32_t config_version;                /* Версия формата конфигурации */
    uint32_t crc32;                         /* Контрольная сумма */
} cgminer_config_t;

/**
 * @struct work_t
 * @brief Структура рабочего задания
 * 
 * Содержит данные для майнинга одного блока.
 * Получается от пула через Stratum протокол.
 */
typedef struct work {
    /* ------------------------------------------
     * Идентификация работы
     * ------------------------------------------ */
    uint32_t id;                            /* Уникальный ID работы */
    char job_id[MAX_JOB_ID_LEN];            /* ID задания от пула */
    uint8_t pool_no;                        /* Номер пула */
    
    /* ------------------------------------------
     * Данные блока для майнинга
     * ------------------------------------------ */
    uint8_t prevhash[32];                   /* Хэш предыдущего блока */
    uint8_t merkle_root[32];                /* Корень дерева Меркла */
    uint8_t coinbase1[128];                 /* Первая часть coinbase */
    int coinbase1_len;                      /* Длина coinbase1 */
    uint8_t coinbase2[128];                 /* Вторая часть coinbase */
    int coinbase2_len;                      /* Длина coinbase2 */
    uint8_t merkle_branch[16][32];          /* Ветви дерева Меркла */
    int merkle_count;                       /* Количество ветвей */
    uint32_t version;                       /* Версия блока */
    uint32_t ntime;                         /* Время блока */
    uint32_t nbits;                         /* Сложность (компактная форма) */
    
    /* ------------------------------------------
     * Данные для ASIC
     * ------------------------------------------ */
    uint8_t header[128];                    /* Заголовок блока (80 байт + padding) */
    uint8_t target[32];                     /* Целевой хэш */
    double difficulty;                      /* Сложность */
    
    /* ------------------------------------------
     * ExtraNonce
     * ------------------------------------------ */
    uint8_t extranonce1[16];                /* ExtraNonce1 от пула */
    int extranonce1_len;                    /* Длина ExtraNonce1 */
    uint8_t nonce2[8];                      /* ExtraNonce2 */
    int nonce2_len;                         /* Длина ExtraNonce2 */
    uint32_t nonce;                         /* Найденный nonce */
    
    /* ------------------------------------------
     * Временные метки
     * ------------------------------------------ */
    time_t timestamp;                       /* Время получения работы */
    int stale;                              /* 1 = работа устарела */
    
    struct work *next;                      /* Следующая работа в списке */
} work_t;

/* ===========================================================================
 * ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ (extern)
 * 
 * Объявления внешних переменных, определённых в main.c
 * =========================================================================== */

/* Конфигурация */
extern cgminer_config_t g_config;           /* Глобальная конфигурация */

/* Мьютексы */
extern SemaphoreHandle_t g_pool_mutex;      /* Мьютекс пулов */
extern SemaphoreHandle_t g_work_mutex;      /* Мьютекс работ */
extern SemaphoreHandle_t g_stats_mutex;     /* Мьютекс статистики */

/* Параметры */
extern int g_debug_level;                   /* Уровень отладки */
extern int g_log_level;                     /* Уровень логирования */
extern int g_pool_strategy;                 /* Стратегия выбора пула */
extern int g_log_interval;                  /* Интервал логирования */

/* Счётчики устройств */
extern int g_asc_count;                     /* Количество ASIC */
extern int g_pga_count;                     /* Количество PGA */

/* Флаги состояния */
extern volatile int g_mining_active;        /* Флаг активного майнинга */
extern volatile int g_want_quit;            /* Флаг завершения */

/* Время */
extern time_t g_start_time;                 /* Время запуска */

/* Названия стратегий */
extern const char *pool_strategy_names[];

/* ===========================================================================
 * ПРОТОТИПЫ ГЛОБАЛЬНЫХ ФУНКЦИЙ
 * =========================================================================== */

/**
 * @brief Логирование сообщения с уровнем важности
 * 
 * @param level Уровень (LOG_ERR, LOG_WARNING, LOG_NOTICE, LOG_INFO, LOG_DEBUG)
 * @param fmt   Форматная строка (как printf)
 * @param ...   Аргументы
 */
void log_message(int level, const char *fmt, ...);

/* ===========================================================================
 * МАКРОСЫ ЛОГИРОВАНИЯ
 * 
 * Удобные макросы для логирования с автоматическим уровнем.
 * =========================================================================== */

/**
 * @brief Логирование ошибки
 */
#define LOG_ERROR(fmt, ...)     log_message(LOG_ERR, fmt, ##__VA_ARGS__)

/**
 * @brief Логирование предупреждения
 */
#define LOG_WARN(fmt, ...)      log_message(LOG_WARNING, fmt, ##__VA_ARGS__)

/**
 * @brief Логирование информации
 */
#define LOG_MSG(fmt, ...)       log_message(LOG_NOTICE, fmt, ##__VA_ARGS__)

/**
 * @brief Логирование отладки
 */
#define LOG_DBG(fmt, ...)       log_message(LOG_DEBUG, fmt, ##__VA_ARGS__)

#endif /* __CGMINER_H__ */

/* ===========================================================================
 * КОНЕЦ ФАЙЛА cgminer.h
 * =========================================================================== */
