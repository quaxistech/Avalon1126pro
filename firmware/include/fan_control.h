/**
 * =============================================================================
 * @file    fan_control.h
 * @brief   Заголовочный файл управления вентиляторами
 * =============================================================================
 * 
 * Определения для системы охлаждения:
 * - Режимы работы
 * - Структуры данных
 * - Прототипы функций
 * 
 * @author  Reconstructed from Avalon A1126pro firmware
 * @version 1.0
 * =============================================================================
 */

#ifndef FAN_CONTROL_H
#define FAN_CONTROL_H

#include <stdint.h>
#include <stdbool.h>

#ifdef __cplusplus
extern "C" {
#endif

/* =============================================================================
 * КОНСТАНТЫ
 * ============================================================================= */

/** Количество вентиляторов в системе */
#define FAN_COUNT               2

/* =============================================================================
 * ТИПЫ И ПЕРЕЧИСЛЕНИЯ
 * ============================================================================= */

/**
 * @brief   Режим работы вентиляторов
 */
typedef enum {
    FAN_MODE_AUTO = 0,      /**< Автоматический (ПИД-регулирование) */
    FAN_MODE_MANUAL = 1     /**< Ручной (фиксированная скорость) */
} fan_mode_t;

/**
 * @brief   Статус системы охлаждения
 */
typedef enum {
    FAN_STATUS_OK = 0,          /**< Всё в норме */
    FAN_STATUS_WARNING,         /**< Предупреждение о высокой температуре */
    FAN_STATUS_CRITICAL,        /**< Критическая температура */
    FAN_STATUS_EMERGENCY,       /**< Аварийный режим */
    FAN_STATUS_FAN0_FAIL,       /**< Вентилятор 0 не работает */
    FAN_STATUS_FAN1_FAIL,       /**< Вентилятор 1 не работает */
    FAN_STATUS_DISABLED         /**< Система отключена */
} fan_status_t;

/**
 * @brief   Состояние системы охлаждения
 */
typedef struct {
    fan_mode_t mode;            /**< Текущий режим работы */
    uint8_t target_temp;        /**< Целевая температура (°C) */
    uint8_t duty_cycle[FAN_COUNT];  /**< Текущая скважность ШИМ (%) */
    uint32_t rpm[FAN_COUNT];    /**< Текущие обороты (RPM) */
    bool enabled;               /**< Система включена */
} fan_state_t;

/* =============================================================================
 * ПРОТОТИПЫ ФУНКЦИЙ
 * ============================================================================= */

/**
 * @name    Инициализация и управление
 * @{
 */

/**
 * @brief   Инициализация системы охлаждения
 * @return  0 при успехе
 */
int fan_init(void);

/**
 * @brief   Обновление системы охлаждения
 * @param   temp_board: температура платы (°C)
 * @param   temp_chips: средняя температура чипов (°C)
 * @return  Статус системы охлаждения
 */
fan_status_t fan_update(float temp_board, float temp_chips);

/**
 * @brief   Экстренная остановка вентиляторов
 */
void fan_emergency_stop(void);

/**
 * @brief   Включение вентиляторов на максимум
 */
void fan_test_max(void);

/** @} */

/**
 * @name    Настройка
 * @{
 */

/**
 * @brief   Установка режима работы
 * @param   mode: режим (FAN_MODE_AUTO или FAN_MODE_MANUAL)
 */
void fan_set_mode(fan_mode_t mode);

/**
 * @brief   Установка целевой температуры
 * @param   temp: целевая температура (°C)
 */
void fan_set_target_temp(uint8_t temp);

/**
 * @brief   Ручная установка скорости
 * @param   fan_id: номер вентилятора (-1 для всех)
 * @param   percent: скорость (0-100%)
 */
void fan_set_speed(int fan_id, uint8_t percent);

/** @} */

/**
 * @name    Информация
 * @{
 */

/**
 * @brief   Получение состояния системы
 * @return  Указатель на структуру состояния
 */
const fan_state_t *fan_get_state(void);

/**
 * @brief   Получение текущих RPM
 * @param   rpm0: указатель для RPM вентилятора 0
 * @param   rpm1: указатель для RPM вентилятора 1
 */
void fan_get_rpm(uint32_t *rpm0, uint32_t *rpm1);

/** @} */

#ifdef __cplusplus
}
#endif

#endif /* FAN_CONTROL_H */
